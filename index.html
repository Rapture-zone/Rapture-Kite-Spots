<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
<link rel="stylesheet" href="css/leaflet.css">
<link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
<link rel="stylesheet" href="css/L.Control.Locate.min.css">
<link rel="stylesheet" href="css/qgis2web.css">
<link rel="stylesheet" href="css/fontawesome-all.min.css">
<link rel="stylesheet" href="css/leaflet.photon.css">
<style>
  html, body, #map {width:100%;height:100%;margin:0;padding:0;}
  .label-state{color:#323232;font-size:10pt;font-family:'Open Sans',sans-serif;text-shadow:0 0 2px rgba(255,255,255,.85);pointer-events:none}
  .leaflet-interactive{cursor:pointer}
</style>
</head>
<body>
<div id="map"></div>

<script src="js/qgis2web_expressions.js"></script>
<script src="js/leaflet.js"></script>
<script src="js/L.Control.Layers.Tree.min.js"></script>
<script src="js/L.Control.Locate.min.js"></script>
<script src="js/leaflet.rotatedMarker.js"></script>
<script src="js/leaflet.pattern.js"></script>
<script src="js/leaflet-hash.js"></script>
<script src="js/Autolinker.min.js"></script>
<script src="js/rbush.min.js"></script>
<script src="js/labelgun.min.js"></script>
<script src="js/labels.js"></script>
<script src="js/leaflet.photon.js"></script>
<script src="data/SouthAustralia_1.js"></script>
<script src="data/Victoria_2.js"></script>
<script src="data/WesternAustralia_3.js"></script>

<script>
// --- Map init ---
var map = L.map('map',{zoomControl:false,minZoom:3,maxZoom:13});
new L.Hash(map);
L.control.zoom({position:'topleft'}).addTo(map);
L.control.locate({locateOptions:{maxZoom:10}}).addTo(map);

// Initial view / bounds
var AU_BOUNDS = L.latLngBounds([[-44,112],[-10,154]]);
map.fitBounds(AU_BOUNDS);
map.setMaxBounds(AU_BOUNDS.pad(0.15));

// Basemap
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

var autolinker = new Autolinker({truncate:{length:36,location:'smart'}});
var isTouch = window.matchMedia('(pointer: coarse)').matches;

// ==== Invisible hitbox helpers (bigger tap/click area) ====
const HIT_RADIUS = 20; // tweak this to make tapping easier/harder

function visibleChild(layer){
  let vis = null;
  if (layer instanceof L.FeatureGroup) {
    layer.eachLayer(ch => { if (ch.options && ch.options._isVisible) vis = ch; });
  }
  return vis || layer;
}

// Build: white halo (outer), black outline + fill (visible), invisible hitbox
function markerWithHitbox(latlng, fillColor){
  // Main visible dot (fill + black 1px outline)
  const visible = L.circleMarker(latlng, {
    radius: 4,
    weight: 1,
    color: 'black',          // inner outline
    fillColor: fillColor,    // keep your original layer fill colour
    fillOpacity: 1,
    opacity: 1,
    _isVisible: true
  });

  // White halo behind it (slightly larger, hollow with white 1px stroke)
  const halo = L.circleMarker(latlng, {
    radius: 5.5,             // slightly bigger than visible (4 -> 5.5)
    weight: 1,
    color: 'white',          // outer halo
    fillOpacity: 0,
    opacity: 1,
    interactive: false       // halo does not capture events
  });

  // Invisible hitbox to improve touch/click
  const hitbox = L.circleMarker(latlng, {
    radius: HIT_RADIUS,
    stroke: false,
    fill: true,
    fillOpacity: 0,
    interactive: true,
    bubblingMouseEvents: false
  });

  // Link halo to visible so we can resize it on hover
  visible.__halo = halo;

  // Forward interactions from hitbox → visible (so behavior attaches once)
  ['click','mouseover','mouseout','mousemove','mousedown','mouseup','contextmenu']
    .forEach(ev => hitbox.on(ev, e => visible.fire(ev, e)));

  // Keep layering order: halo (bottom) → visible → hitbox (top, invisible)
  return L.featureGroup([halo, visible, hitbox]);
}

// Hover behaviour WITH growth (updates both visible + halo)
function grow(layer){
  const visible = layer; // layer is the visible child
  const halo = visible.__halo;
  visible.setStyle({ radius: 7, weight: 2 });        // larger dot, thicker outline
  if (halo) halo.setStyle({ radius: 8.5, weight: 1 }); // keep ~1.5px larger halo
}
function shrink(layer, fillColor){
  const visible = layer;
  const halo = visible.__halo;
  visible.setStyle({
    radius: 4,
    weight: 1,
    color: 'black',
    fillColor: fillColor,
    fillOpacity: 1,
    opacity: 1
  });
  if (halo) halo.setStyle({ radius: 5.5, weight: 1, color: 'white' });
}

// Link utils
function normalizeLink(raw){
  if(!raw) return '';
  var href = String(raw).trim();
  if(href.indexOf('<a') !== -1){
    var div = document.createElement('div');
    div.innerHTML = href; var a = div.querySelector('a');
    if(a && a.getAttribute('href')) href = a.getAttribute('href');
  }
  if(/^https?:\/\//i.test(href)) return href;
  if(href.slice(0,7).toLowerCase()==='file://') href = href.slice(7);
  href = href.split('\\').join('/');
  var parts = href.split('/'); var file = parts.length?parts[parts.length-1]:'';
  if(!file) return '';
  var slug = file.replace(/\.(html?|htm)$/i,'');
  return 'https://rapture.zone/' + slug;
}

function bindLayer(feature, layer, fillColor){
  var p = feature && feature.properties ? feature.properties : {};
  var href = normalizeLink(p.Link_HTML); var name = p.Name || '';
  if(!isTouch){
    if(name) layer.bindTooltip('<div class="label-state">'+name+'</div>', {direction:'top', offset:[0,-14], className:'label-state'});
    layer.on('mouseover', function(){ layer.openTooltip(); grow(layer); });
    layer.on('mouseout',  function(){ layer.closeTooltip(); shrink(layer, fillColor); });
    layer.on('click',     function(){ if(href) window.open(href,'_blank','noopener'); });
  } else {
    var popupContent = '<div><a href="'+href+'" target="_blank" rel="noopener">'+(name||href)+'</a></div>';
    layer.bindPopup(popupContent,{maxHeight:400});
  }
}

// --- Panes ---
map.createPane('pane_SouthAustralia_1');
map.getPane('pane_SouthAustralia_1').style.zIndex = 401;
map.getPane('pane_SouthAustralia_1').style['mix-blend-mode'] = 'normal';

map.createPane('pane_Victoria_2');
map.getPane('pane_Victoria_2').style.zIndex = 402;
map.getPane('pane_Victoria_2').style['mix-blend-mode'] = 'normal';

map.createPane('pane_WesternAustralia_3');
map.getPane('pane_WesternAustralia_3').style.zIndex = 403;
map.getPane('pane_WesternAustralia_3').style['mix-blend-mode'] = 'normal';

// --- Layers (use hitbox wrapper + visibleChild to bind events) ---
var layer_SouthAustralia_1 = L.geoJson(json_SouthAustralia_1,{
  pane:'pane_SouthAustralia_1',
  onEachFeature:function(f,l){ bindLayer(f, visibleChild(l), 'rgba(228,166,182,1.0)'); },
  pointToLayer:function(f,ll){ return markerWithHitbox(ll, 'rgba(228,166,182,1.0)'); }
});
var layer_Victoria_2 = L.geoJson(json_Victoria_2,{
  pane:'pane_Victoria_2',
  onEachFeature:function(f,l){ bindLayer(f, visibleChild(l), 'rgba(225,195,110,1.0)'); },
  pointToLayer:function(f,ll){ return markerWithHitbox(ll, 'rgba(225,195,110,1.0)'); }
});
var layer_WesternAustralia_3 = L.geoJson(json_WesternAustralia_3,{
  pane:'pane_WesternAustralia_3',
  onEachFeature:function(f,l){ bindLayer(f, visibleChild(l), 'rgba(132,194,140,1.0)'); },
  pointToLayer:function(f,ll){ return markerWithHitbox(ll, 'rgba(132,194,140,1.0)'); }
});

map.addLayer(layer_SouthAustralia_1);
map.addLayer(layer_Victoria_2);
map.addLayer(layer_WesternAustralia_3);

// Layer tree
new L.Control.Layers.Tree(null, [
  {label:'South Australia', layer:layer_SouthAustralia_1},
  {label:'Victoria',        layer:layer_Victoria_2},
  {label:'Western Australia', layer:layer_WesternAustralia_3},
], {collapsed:false}).addTo(map);

// Fit bounds
try{
  var fg = L.featureGroup([layer_SouthAustralia_1, layer_Victoria_2, layer_WesternAustralia_3]);
  var b  = fg.getBounds(); if(b && b.isValid()) map.fitBounds(b.pad(0.2));
}catch(e){ console.warn(e); }
</script>
</body>
</html>
